---
title: "KPR_Network_Analysis.Rmd"
author: "Whitney Friedman"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    thumbnails: false
    lightbox: false
    gallery: false
    highlight: tango
---

# KPR Network Analysis
This RMD describes and generates the KPR network analysis that is presented in Friedman et al. 2021

2009-2014 Network Analysis
- Community structure: How many 2nd order alliances are in this network of (22?) males?
- Centrality:
-- Strength: overall
-- wStrength: 
--- bStrength vs wStrength: The proportion of each individual’s total strength that is within-group (darker color) versus between-group (lighter color). 
--- bStrengthR: Nodes are sized based on an individual’s relativized between-group strength value (bStrengthR). In each second-order alliance there was one trio with higher bStrength values than other males, indicating that within second-order alliances, one first-order alliance (or possibly a subset of males therein) plays a key role in maintaining third-order alliance relationships

Temporal shifts: T1 (2009-10), T2 (2011-12), T3 (2013-14)
To examine the change in alliance relationships through time, we divided the six-year dataset into three two-year periods: 2009-2010 (T1), 2011-2012 (T2), and 2013-2014 (T3). Network measures used to describe differences during these periods include: 
- Community structure
- Centrality (wStrength vs. bStrength)

Modeling Change - Theoretical Knockout
- QAP: T1-T2, T2-T3
-- Matrix permutation analysis (QAP) demonstrated a significant positive correlation in the networks of KS and PD males persisting between T1 and T2 (r = 0.828, p < 0.001, 5000 permutations). The correlation between the network of KS and PD males persisting through the T2 and T3 periods was lower, though still highly significant (r = 0.757, p < 0.001, 5000 permutations). 
- wStrength & bStrength:
-- Comparison of the topological knockout model T2ko to observed shifts between T2 and T3 revealed substantial differences in individual centrality measures. 
-- The T2ko model predicted an increase in mean wStrength for PD males: since two PD males were removed, similar levels of association among fewer males would mean larger mean wStrength values for all remaining members of PD. 
-- No change in mean wStrength was predicted for KS or RR males, since they experienced no change in membership. The observed change shows an overall decrease in mean wStrength for all KS, PD, and RR males (Figure 4A). 
-- The T2ko model predicted a decrease in mean bStrength for KS males, and no change for PD or RR males. 
-- The observed change showed an overall *increase* in mean bStrength in the KPR network except the two first-order allies of the deceased PD male PRI (Figure 4B,C). In summary, PD decreased their within-group associations relative to what was expected, and increased their between-group associations relative to what was expected. Following the loss of their second-order allies, they increased their association frequency with third-order allies. (This demonstrates the dynamic building of alliance relationships over time.)

Key Files in this analysis: 
- networkStats_PRS.R
- networkStats.R
- networks_1314.R
- networkStats_2y_pub.R


```{r setup, include=FALSE}
require(knitr)
opts_chunk$set(echo = TRUE)
opts_knit$set(root.dir = "~/GoogleDriveSync/DAP_sync")

# Knit to html, then use code below in terminal to copy into sharing folder.
# Note: This will make this Rmd publicly accessible (to anyone with the link)
# cp source destination
# cp ~/GoogleDriveSync/DAP_sync/Aerial/DataAnalysis/src/KPR_Network_Analysis.html ~/Documents/Projects/Websharing/wrfriedman.github.io/dap/KPR_Network_Analysis.html 
# git commit

```

# Setup 
```{r warning=FALSE, message=FALSE}
library(tidyverse)
library(psych)
library(gridExtra)
library(readxl)
library(janitor)
library(lubridate)
library(here)

#setwd("/Users/friedman/GoogleDriveSync/DAP_sync")

#source("KPR_functions.R")

export_dir <- "/Users/friedman/GoogleDriveSync/DAP_sync/Aerial/Publications/KPR_Network/May2021/"
```
# Load files

## List of IDs and alliances
```{r}
kpr_ids <- 
  read_csv("Aerial/DataAnalysis/Network/KsPdRr09-14/FinalAnalysis/Inputs/KSPDRR_Supplemental.csv") %>% 
  clean_names()

kpr_ids

```

## Centrality measures
- Generated by "networkStats_KPR.R"

```{r}
source(here("Aerial","DataAnalysis","src","networkStats_KPR.R"))
# Creates tables d0914, d0910, d1112, d1112k, d1314 which contain 
# all relevant centrality measures (including new "wStrengthN" and "bStrengthN")
d0910
d0914

```

```{r eval=FALSE, include=FALSE}
# Export tables (OPTIONAL)

write_csv(d0914, paste0(export_dir,"centrality_new_0914.csv"))
write_csv(d0910, paste0(export_dir,"centrality_new_0910.csv"))
write_csv(d1112, paste0(export_dir,"centrality_new_1112.csv"))
write_csv(d1112k, paste0(export_dir,"centrality_new_1112k.csv"))
write_csv(d1314, paste0(export_dir,"centrality_new_1314.csv"))

```


## Load association data
Association files were exported from SOCPROG. The input file was a survey file with group information in which groups
- Activity was S/R/T
- 5min survey was completed (group was not lost).
- Not a resight
- See file: "0914_SNA_KPR_Surveys_Final.xlsx" for query and SOCPROG information.

Association data are used to build networks

### Load 09-14 association data
```{r}
# ama = "All known males associations" 
ama0914 <- read_delim(
  here("Aerial", "DataAnalysis","Network", "KsPdRr09-14","FinalAnalysis", "associationMatrices", 
       "0914_AMA_Assoc.txt"),
  delim = " ", 
  col_names = T) %>% 
  clean_names() %>% 
  rename(hwi = associations)

ama0914

# kpr = krokers, primas, or rascals.
kpr0914 <- ama0914 %>% 
  filter(from %in% kpr_ids$id) %>% 
  filter(to %in% kpr_ids$id)

kpr0914
```
### Load 09-10 association data

```{r}
# ama = "All known males associations" 
ama0910 <- read_delim(
  here("Aerial", "DataAnalysis","Network", "KsPdRr09-14","FinalAnalysis","associationMatrices",
       "0910_AMA_Assoc.txt"), 
  delim = " ", 
  col_names = T) %>% 
  clean_names() %>% 
  rename(hwi = associations)

ama0910

# kpr = krokers, primas, or rascals.
kpr0910 <- ama0910 %>% 
  filter(from %in% kpr_ids$id) %>% 
  filter(to %in% kpr_ids$id)

kpr0910
```

### Load 11-12 association data

```{r}
# ama = "All known males associations" 
ama1112 <- read_delim(
  here("Aerial", "DataAnalysis","Network", "KsPdRr09-14","FinalAnalysis","associationMatrices",
       "1112_AMA_Assoc.txt"), 
  delim = " ", 
  col_names = T) %>% 
  clean_names() %>% 
  rename(hwi = associations)

ama1112

# kpr = krokers, primas, or rascals.
kpr1112 <- ama1112 %>% 
  filter(from %in% kpr_ids$id) %>% 
  filter(to %in% kpr_ids$id)

kpr1112
```

### Load 13-14 KO data
...
```{r}
# 1112ko
```


### Load 13-14 association data
```{r}
# ama = "All known males associations" 
ama1314 <- read_delim(
  here("Aerial", "DataAnalysis","Network", "KsPdRr09-14","FinalAnalysis","associationMatrices",
       "1314_AMA_Assoc.txt"), 
  delim = " ", 
  col_names = T) %>% 
  clean_names() %>% 
  rename(hwi = associations)

ama1314

# kpr = krokers, primas, or rascals.
kpr1314 <- ama1314 %>% 
  filter(from %in% kpr_ids$id) %>% 
  filter(to %in% kpr_ids$id)

kpr1314
```

# Export seperate 13-14 centrality tables for KS-PD and KS-RR
- Addressing the question: "who are the key players in maintaining the ks&pd (and ks&rr) alliance in 2013-14"
- Looking at the two sets of 3' allies seperately
- Need to re-calculate bStrengthR & bStrengthN with these smaller groups

```{r}
ids_ks_1314 <- kpr_ids %>% 
  filter(alliance == "KS") %>% 
  filter(!id %in% c("BOL","MID")) %>% 
  pull(id)

ids_pd_1314 <- kpr_ids %>% 
  filter(alliance == "PD") %>% 
  filter(!id %in% c("BAR","PRI")) %>% 
  pull(id)

ids_rr_1314 <- kpr_ids %>% 
  filter(alliance == "RR") %>% 
  pull(id)
  
# Calculate bstrength for KS males in KS-PD network

ks2pd_1314 <- ama1314 %>% 
  filter(from %in% ids_ks_1314) %>% 
  filter(to %in% ids_pd_1314) %>% 
  group_by(from) %>% 
  summarise(bStrength = sum(hwi)) %>% 
  rename(ID = from) %>%  
  mutate(bStrengthN = bStrength / max(bStrength))

pd2ks_1314 <- ama1314 %>% 
  filter(from %in% ids_pd_1314) %>% 
  filter(to %in% ids_ks_1314) %>% 
  group_by(from) %>% 
  summarise(bStrength = sum(hwi)) %>% 
  rename(ID = from) %>% 
  mutate(bStrengthN = bStrength / max(bStrength))

# Create new centrality tables
# d1314 %>% 
```


```{r}

# KS & PD:
d1314_kspd <- d1314 %>% 
  filter(Alliance %in% c("KS","PD")) %>% 
  select(ID, Alliance, totKS, totPD) %>% 
  mutate(bSize = case_when(Alliance == "KS" ~ sum(Alliance != "KS"),
                           Alliance == "PD" ~ sum(Alliance != "PD"))) %>% 
  mutate(bStrength = case_when(Alliance == "KS" ~ totPD, 
                            Alliance == "PD" ~ totKS)) %>% 
  mutate(bStrengthR = bStrength/bSize)

bstrength_max_KS <- max(d1314_kspd$bStrength[d1314_kspd$Alliance == "KS"])
bstrength_max_PD <- max(d1314_kspd$bStrength[d1314_kspd$Alliance == "PD"])
                                     
d1314_kspd <- d1314_kspd %>% 
  mutate(bStrength_max = case_when(Alliance == "KS" ~ bstrength_max_KS, 
                                   Alliance == "PD" ~ bstrength_max_PD)) %>% 
  mutate(bStrengthN = bStrength/bStrength_max)

d1314_kspd


# KS & RR
d1314_ksrr <- d1314 %>% 
  filter(Alliance %in% c("KS","RR")) %>% 
  select(ID, Alliance, totKS, totRR) %>% 
  mutate(bSize = case_when(Alliance == "KS" ~ sum(Alliance != "KS"),
                           Alliance == "RR" ~ sum(Alliance != "RR"))) %>% 
  mutate(bStrength = case_when(Alliance == "KS" ~ totRR, 
                            Alliance == "RR" ~ totKS)) %>% 
  mutate(bStrengthR = bStrength/bSize)


bstrength_max_KS <- max(d1314_ksrr$bStrength[d1314_ksrr$Alliance == "KS"])
bstrength_max_RR <- max(d1314_ksrr$bStrength[d1314_ksrr$Alliance == "RR"])
                                     
d1314_ksrr <- d1314_ksrr %>% 
  mutate(bStrength_max = case_when(Alliance == "KS" ~ bstrength_max_KS, 
                                   Alliance == "RR" ~ bstrength_max_RR)) %>% 
  mutate(bStrengthN = bStrength/bStrength_max)

d1314_ksrr


```

# Export new centrality tables
NOTE! Eval==F so we're not exporting every time.

```{r eval=FALSE, include=FALSE}
# Note the columns "totKS" and "totPD" are the sum of HWIs' for that group
# So for KS males, "totKS" == "wStrength", and for the ks-pd restricted 
# network,"totPD" == bStrength

write_csv(d1314_kspd, paste0(export_dir,"centrality_kspd_1314.csv"))


write_csv(d1314_ksrr, paste0(export_dir,"centrality_ksrr_1314.csv"))

kpr1314 %>% 
  rename(source = "from",
         target = "to") %>% 
  write_csv(paste0(export_dir, "assoc_kpr_1314.csv"))

```


## Barplots 
```{r}
# KS PD 1314 
bStrengthN_3q <- summary(d1314_kspd$bStrengthN)[5][[1]]
bStrengthN_median <- summary(d1314_kspd$bStrengthN)[3][[1]]

# Dashed line = median; Solid line = 3rd Quartile
kspd_plt <- d1314_kspd %>% 
  mutate(ID = factor(ID, levels = kpr_ids$id)) %>% 
  ggplot(aes(x=ID,y=bStrengthN, fill = Alliance)) +
    geom_bar(stat = "identity") + 
    scale_fill_manual(values=c("forestgreen","blue"))+
    geom_hline(yintercept = bStrengthN_3q) +
    geom_hline(yintercept = bStrengthN_median, linetype = "dashed")+
    ggtitle("bStrength_N KS-PD 2013-14")
    
kspd_plt

# KS RR 1314 
bStrengthN_3q <- summary(d1314_ksrr$bStrengthN)[5][[1]]
bStrengthN_median <- summary(d1314_ksrr$bStrengthN)[3][[1]]

# Dashed line = median; Solid line = 3rd Quartile
ksrr_plt <- d1314_ksrr %>% 
  mutate(ID = factor(ID, levels = kpr_ids$id)) %>% 
  ggplot(aes(x=ID,y=bStrengthN, fill = Alliance)) +
    geom_bar(stat = "identity") + 
    scale_fill_manual(values=c("forestgreen","firebrick"))+
    geom_hline(yintercept = bStrengthN_3q) +
    geom_hline(yintercept = bStrengthN_median, linetype = "dashed") + 
    ggtitle("bStrength_N KS-RR 2013-14")
    
ksrr_plt

```

Save barplots
- Not run every time.

```{r eval=FALSE, include=FALSE}

ggsave("ksrr_1314_barplot.pdf", plot = ksrr_plt, device = "pdf", 
       path = export_dir, width = 8, height = 5)

ggsave("kspd_1314_barplot.pdf", plot = kspd_plt, device = "pdf", 
       path = export_dir, width = 8, height = 5)

```




# Create Networks


## Load libraries for network visualization
- To use 'ForceAtlas2' (as in Gephi), install below:
- devtools::install_github("analyxcompany/ForceAtlas2")
- (https://github.com/analyxcompany/ForceAtlas2)

```{r message=FALSE, warning=FALSE}
library(igraph)
library(ggraph)
```

## Add alliance relationship to to-from tables
```{r}

# Generate all pairwise permutations of all ks, pd, and rr members for the 2009-2014 period
kpr_order <- tibble(from = kpr_ids$id,
              to   = kpr_ids$id) %>% 
  expand(from,to) %>%
  left_join(kpr_ids, by=c("from"="id")) %>% 
  rename(from_alliance = alliance) %>% 
  left_join(kpr_ids, by = c("to" = "id")) %>% 
  rename(to_alliance = alliance) %>% 
  mutate(relationship = case_when(from_alliance == to_alliance ~ 2, 
                                  from_alliance != to_alliance ~ 3)) %>% 
  select(from, to, relationship)


kpr_order

```


## 2009-14 KPR Network
```{r}
edges_0914 <- kpr0914 %>% 
  left_join(kpr_order, by = c("from","to")) 

nodes_0914 <- d0914 %>% 
  rename(name = ID) %>%
  select(name, Alliance, bStrength_KPR, bStrengthN, bStrengthR, wStrength, 
         wStrengthN, wStrengthR)

net_0914 <- edges_0914 %>% 
  drop_na() %>% 
  graph_from_data_frame(directed = F, vertices = nodes_0914)

#plot(net_0914) # basic plot

# size by bStrengthN
set.seed(1986)
g_plt <- ggraph(net_0914, layout = 'fr', weights = hwi)+
    geom_edge_link(aes(width = hwi/10, alpha=0.1), edge_colour="grey60")+
    #geom_edge_link(aes(alpha = .5),edge_colour="grey25")+
    #geom_node_point()+
    geom_node_point(aes(colour = Alliance, size=bStrengthN^4)) +
    scale_colour_manual(values=c("chartreuse3","cornflowerblue","red3"))+
    geom_node_text(aes(label = name), repel = T, size=4)+
    theme_void()

g_plt

# Uncomment to export:
# pdf(here("Aerial","Publications","KPR_Network",
#          "April2020", "outputs","kpr_0914_ggraph.pdf"),
#     height = 8, width = 10)
# plot(g_plt)
# dev.off()

```

## 2009-10 KPR Network
```{r}
edges_0910 <- kpr0910 %>% 
  left_join(kpr_order, by = c("from","to"))

nodes_0910 <- d0910 %>% 
  rename(name = ID) %>% 
  replace_na(list(bStrengthN = 0))

net_0910 <- edges_0910 %>% 
  drop_na() %>% 
  graph_from_data_frame(directed = F, vertices = nodes_0910)

# Plot here
# size by bStrengthN
set.seed(1986)
g_plt <- ggraph(net_0910, layout = 'fr', weights = hwi)+
    geom_edge_link(aes(width = hwi/10, alpha=0.1), edge_colour="grey60")+
    geom_node_point(aes(colour = Alliance, size=bStrengthN^2)) +
    scale_colour_manual(values=c("chartreuse3","cornflowerblue","red3"))+
    geom_node_text(aes(label = name), repel = T, size=4)+
    theme_void()

g_plt
```

## 2011-12 KPR Network
```{r}
edges_1112 <- kpr1112 %>% 
  left_join(kpr_order, by = c("from","to"))

nodes_1112 <- d1112 %>% 
  rename(name = ID) %>% 
  replace_na(list(bStrengthN = 0))

net_1112 <- edges_1112 %>% 
  drop_na() %>% 
  graph_from_data_frame(directed = F, vertices = nodes_1112)

# Plot here
# size by bStrengthN
set.seed(1986)
g_plt <- ggraph(net_1112, layout = 'fr', weights = hwi)+
    geom_edge_link(aes(width = hwi/10, alpha=0.1), edge_colour="grey60")+
    geom_node_point(aes(colour = Alliance, size=bStrengthN^2)) +
    scale_colour_manual(values=c("chartreuse3","cornflowerblue","red3"))+
    geom_node_text(aes(label = name), repel = T, size=4)+
    theme_void()

g_plt
```

## 2013-14 KPR Network
```{r}
edges_1314 <- kpr1314 %>% 
  left_join(kpr_order, by = c("from","to"))

nodes_1314 <- d1314 %>% 
  rename(name = ID) %>% 
  select(name, Alliance, bStrength_KPR, bStrengthN, bStrengthR, wStrength, wStrengthN, wStrengthR)

net_1314 <- edges_1314 %>% 
  drop_na() %>% 
  graph_from_data_frame(directed = F, vertices = nodes_1314)

# Plot here:
# Node size by bStrengthN
set.seed(1986)
g_plt <- ggraph(net_1314, layout = 'fr', weights = hwi)+
    geom_edge_link(aes(width = hwi/10, alpha=0.1), edge_colour="grey60")+
    geom_node_point(aes(colour = Alliance, size=bStrengthN^4)) +
    scale_colour_manual(values=c("chartreuse3","cornflowerblue","red3"))+
    geom_node_text(aes(label = name), repel = T, size=4)+
    theme_void()

g_plt


```

## Export to Gephi
Steps in Gephi: 
- File > Import > *.gml
- Data Table > Edges: Copy hwi to 'Weight' column
- Data Table > Nodes: Copy 'name' to 'Label'
- DOUBLE CHECK EXPORT TABLE HAS ALL VALUES

- Overview > Layout: ForceAtlas2 (select: LinLog, Prevent Overlap)
-- Runs: Stop after 1min, check >500,000 iterations

- Overview > Appearance: 
-- Nodes > Partition > Alliance: KS = green (0,224,36), RR = red (255,51,75), PD = blue (20,149,55)
-- Nodes > Size > Ranking: bstrengthn (min = 50, max = 200) (same for wstrengthn)
-- Edges > Partition: relationship (2.0  = white; 3.0 = black) (opposite for 2')

Preview: 
- Presents: Default straight / kpr-networks
- Font: 70
- Edges > Rescale weight (min = 0.5, max = 15)
- Node labels > Aerial 55 plain;  not  proportional.


```{r eval=FALSE, include=T}
# graphml format is working best for opening in Gephi.

write_graph(net_0914,paste0(export_dir, "network_files/kpr_0914.graphml"), format="graphml")
write_graph(net_0910,paste0(export_dir, "network_files/kpr_0910.graphml"), format="graphml")
write_graph(net_1112,paste0(export_dir, "network_files/kpr_1112.graphml"), format="graphml")
write_graph(net_1314,paste0(export_dir, "network_files/kpr_1314.graphml"), format="graphml")
```


## 13-14 KS-PD and KS-RR networks
- Create separate networks for KS-PD and KS-RR for the 2013-14 period

### visNetwork for 13-14 KPR
https://datastorm-open.github.io/visNetwork/
https://www.r-bloggers.com/2019/06/interactive-network-visualization-with-r/

```{r}
library(visNetwork)
library(htmlwidgets)

id_list <- kpr_ids %>% 
  #filter(!id %in% c("BOL","MID","KRO","NOG")) %>%
  filter(!id %in% c("BOL","MID")) %>%
  select(id) %>% pull()

```

```{r}
edge_df <- kpr1314 %>% 
  filter(from %in% id_list) %>% 
  filter(to %in% id_list) %>% 
  mutate(width = hwi*10,
         label = hwi)

node_df <- d1314 %>% 
  clean_names() %>% 
  filter(id %in% id_list) %>% 
  mutate(label = id, 
         value = b_strength_n, 
         color = case_when(alliance == "KS" ~ "forestgreen", 
                           alliance == "PD" ~ "cornflowerblue", 
                           alliance == "RR" ~ "red"),
         shadow = F)

# works but not as informative:
# visNetwork(node_df, edge_df) %>%
#  visPhysics(solver = "forceAtlas2Based", 
#           forceAtlas2Based = list(gravitationalConstant = -50,
#                                   avoidOverlap = .1))


vn <- visNetwork(node_df, edge_df, width = "100%", main = "KPR 2013-14") %>% 
  visIgraphLayout(layout = "layout_nicely") %>%
  #visIgraphLayout(layout = "layout_in_circle") %>%
  visNodes(size = 10) %>%
  visEdges(color = list(color = "lightblue",highlight ="black")) %>% 
  visOptions(highlightNearest = list(enabled = T, degree = 1, hover = T),
             selectedBy = "id") %>% 
  visLayout(randomSeed = 11)

vn

saveWidget(vn, "/Users/friedman/Documents/Projects/Websharing/wrfriedman.github.io/dap/kpr_1314_v2.html")

 
```

### External ties only (KPR network)
- 13-14 KPR network showing ONLY external ties. 
- If alliance is KS, remove all KS ties. etc. 

```{r}
edge_df <- kpr1314 %>% 
  filter(from %in% id_list) %>% 
  filter(to %in% id_list) %>% 
  mutate(width = hwi*10,
         label = hwi) %>%
  left_join(kpr_ids %>% 
              mutate(from = id, 
                     from_alliance = alliance) %>%
              select(from, from_alliance), 
            by = "from") %>% 
  left_join(kpr_ids %>% 
              mutate(to = id, 
                     to_alliance = alliance) %>% 
              select(to, to_alliance), 
            by = "to") %>% 
  # remove all internal network ties
  mutate(same_alliance = case_when(from_alliance == to_alliance ~ 1, 
                                   TRUE ~ 0)) %>% 
  filter(same_alliance == 0)

node_df <- d1314 %>% 
  clean_names() %>% 
  filter(id %in% id_list) %>% 
  mutate(label = id, 
         value = b_strength_n, 
         color = case_when(alliance == "KS" ~ "forestgreen", 
                           alliance == "PD" ~ "cornflowerblue", 
                           alliance == "RR" ~ "red"),
         shadow = F)



vn <- visNetwork(node_df, edge_df, width = "100%", main = "KPR 2013-14 External Ties") %>% 
  #visIgraphLayout(layout = "layout_in_circle") %>%
  visIgraphLayout(layout = "layout_with_kk") %>%
  #visPhysics(solver = "forceAtlas2Based", 
  #           forceAtlas2Based = list(gravitationalConstant = -20,
  #                                   avoidOverlap = .1)) %>% 
  visNodes(size = 2) %>%
  visEdges(color = list(color = "lightblue",highlight ="black")) %>% 
  visOptions(highlightNearest = list(enabled = T, degree = 1, hover = T),
             selectedBy = "id") %>% 
  visLayout(randomSeed = 11)

vn

saveWidget(vn, "/Users/friedman/Documents/Projects/Websharing/wrfriedman.github.io/dap/kpr_1314.html")

 
```


```{r}
# Heatmap

hwi_table  <- kpr1314

hwi_ordered_table <- hwi_table %>% 
  mutate(from = factor(from,
                          levels = kpr_ids$id,
                          ordered = T), 
         to = factor(to,
                     levels = kpr_ids$id,
                     ordered = T))

hwi_heatmap <- ggplot(hwi_ordered_table, aes(from, to)) +
    geom_tile(aes(fill = log1p(hwi))) + 
    geom_text(aes(label = round(hwi, 2)),size =2) +
    scale_fill_gradient(low = "white", high = "red") 


# Local
pdf(here("Aerial","Publications","KPR_Network",
         "May2021","kpr_1314_heatmap.pdf"),
    height = 10, width = 10)
plot(hwi_heatmap)
dev.off()

# Share to web
pdf("/Users/friedman/Documents/Projects/Websharing/wrfriedman.github.io/dap/kpr_1314_heatmap.pdf",
    height = 10, width = 10)
plot(hwi_heatmap)
dev.off()

```


### visNetwork for 13-14 *KS-PD ONLY!
```{r}

id_list <- kpr_ids %>% 
  filter(alliance %in% c("KS","PD")) %>% 
  #filter(!id %in% c("PRI","BOL","MID","KRO","NOG")) %>% 
  select(id) %>% pull()

id_list


edge_df <- kpr1314 %>% 
  filter(from %in% id_list) %>% 
  filter(to %in% id_list) %>% 
  mutate(width = hwi*10,
         label = hwi)

node_df <- d1314_kspd %>% 
  clean_names() %>% 
  filter(id %in% id_list) %>% 
  mutate(label = id, 
         value = exp(b_strength_n), 
         color = case_when(alliance == "KS" ~ "forestgreen", 
                           alliance == "PD" ~ "cornflowerblue", 
                           alliance == "RR" ~ "red"),
         shadow = F)


vn_kspd <- visNetwork(node_df, edge_df, width = "100%", main = "KS-PD 2013-14") %>% 
  visIgraphLayout(layout = "layout_with_mds", physics = T, randomSeed = 1986) %>%
  visPhysics(solver = "forceAtlas2Based", 
            forceAtlas2Based = list(gravitationalConstant = -500,
                                    avoidOverlap = .5)) %>% 
  visNodes() %>%
  visEdges(color = list(color = "darkseagreen",highlight ="black")) %>% 
  visOptions(highlightNearest = list(enabled = T, degree = 1, hover = T),
             selectedBy = "id")

vn_kspd
 

saveWidget(vn_kspd, "/Users/friedman/Documents/Projects/Websharing/wrfriedman.github.io/dap/kspd_1314.html")

```


### visNetwork for 13-14 *KS-RR ONLY

```{r}

id_list <- kpr_ids %>% 
  filter(alliance %in% c("KS","RR")) %>% 
  #filter(!id %in% c("PRI","BOL","MID","KRO","NOG")) %>% 
  select(id) %>% pull()

id_list


edge_df <- kpr1314 %>% 
  filter(from %in% id_list) %>% 
  filter(to %in% id_list) %>% 
  mutate(width = hwi*10,
         label = hwi)

node_df <- d1314_ksrr %>% 
  clean_names() %>% 
  filter(id %in% id_list) %>% 
  mutate(label = id, 
         value = exp(b_strength_n), 
         color = case_when(alliance == "KS" ~ "forestgreen", 
                           alliance == "PD" ~ "cornflowerblue", 
                           alliance == "RR" ~ "red"),
         shadow = F)


vn_ksrr <- visNetwork(node_df, edge_df, width = "100%", main = "KS-RR 2013-14") %>% 
  visIgraphLayout(layout = "layout_with_mds", physics = T, randomSeed = 1986) %>%
  visPhysics(solver = "forceAtlas2Based", 
            forceAtlas2Based = list(gravitationalConstant = -500,
                                    avoidOverlap = .1)) %>% 
  visNodes() %>%
  visEdges(color = list(color = "lightblue",highlight ="black")) %>% 
  visOptions(highlightNearest = list(enabled = T, degree = 1, hover = T),
             selectedBy = "id")

vn_ksrr
 

saveWidget(vn_ksrr, "/Users/friedman/Documents/Projects/Websharing/wrfriedman.github.io/dap/ksrr_1314.html")

# Export for gephi
#visNetwork(gephi = 'WorldCup2014.json')

```









